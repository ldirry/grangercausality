# https://github.com/arahatashun/Granger-causality-python
#!/usr/bin/python
# -*- coding: utf8 -*-
# Author: Shun Arahata
"""
Code for lasso Granger
"""
import numpy as np
from numpy import linalg as LA
import glmnet_python
from glmnet import glmnet


def lasso_granger(series, P, alpha):
    """Lasso Granger
    A. Arnold, Y. Liu, and N. Abe. Temporal causal modeling with graphical granger methods. In KDD, 200
    :param series: (N,T) matrix
    :param P: length of the lag
    :param alpha: value of the penalization parameter in Lasso
    :return:
    """
    N, T = np.shape(series)
    Am = np.zeros((T - P, P * N))
    bm = np.zeros((T - P, 1))
    for i in range(P, T - 1):
        bm[i - P] = series[0, i + 1]
        Am[i - P, :] = np.fliplr(series[:, i - P:i]).flatten()

    # Lasso using GLMnet
    fit = glmnet(x=Am, y=bm, family='gaussian', alpha=1, lambdau=np.array([alpha]))
    vals2 = fit['beta']  # array of coefficient

    # Outputting aic metric for variable into (N,P) matrix
    th = 0
    aic = (LA.norm(Am @ vals2 - bm, 2)) ** 2 / (T - P) + np.sum(np.abs(vals2) > th) * 2 / (T - P)

    # Reformatting the results into (N,P) matrix
    n1Coeff = np.zeros((N, P))
    for i in range(N):
        n1Coeff[i, :] = vals2[i * P:(i + 1) * P].reshape(P)

    sumCause = np.sum(np.abs(n1Coeff), axis=1)
    sumCause[sumCause < th] = 0
    cause = sumCause
    return cause
